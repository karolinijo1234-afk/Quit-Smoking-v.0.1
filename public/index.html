<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smoking Tracker</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/png" href="/icons/icon-192.png">
<style>
    body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        background-color: #000;
        color: #fff;
        display: flex;
        flex-direction: column; /* stack header on top */
        height: 100vh;
    }
    header {
        display: flex;
        flex-direction: row; /* horizontal tabs */
        background: orange;
        color: white;
        width: 100%;
        height: 60px;
        flex-shrink: 0;
        z-index: 10;
    }
    header button {
        flex: 1;
        font-size: 18px;
        background: orange;
        border: none;
        color: white;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    header button.active {
        background: #ff9933; /* lighter orange for active tab */
    }
    .tab-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        position: relative;
    }
    button#recordBtn {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        font-size: 18px;
        background: green;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        z-index: 20;
    }
    .stats { margin-bottom: 20px; font-size: 18px; text-align: center; }
    h1, h2 { text-align: center; color: white; }
    table {
        width: 80%;
        margin: 0 auto;
        border-collapse: collapse;
        margin-top: 10px;
        text-align: center;
        background-color: #111;
        color: white;
    }
    th, td { border: 1px solid #444; padding: 8px; }
    th { background: #222; color: white; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
    <button id="tabTracker" class="active">Tracker</button>
    <button id="tabReports">Reports</button>
</header>


<div id="trackerTab" class="tab-content">
    <h1>Smoking Tracker</h1>
    <div class="stats">
        <p><strong>Today’s total:</strong> <span id="totalToday">0</span></p>
        <p><strong>Average time between cigarettes today:</strong> <span id="avgTime">–</span></p>
        <p><strong>Last cigarette:</strong> <span id="lastTime">–</span></p>
        <p><strong>Time since:</strong> <span id="timeSince">–</span></p>
        <!-- New streak line -->
        <p style="color:limegreen;">
    <strong>Streak:</strong> <span id="streakDays">0</span> days 
    (<strong>Longest:</strong> <span id="longestStreak">0</span> days)
</p>

    </div>
<!-- Quitting Progress -->
<div class="stats" style="text-align:center; margin-top:20px;">
    <p><strong>Quitting Progress:</strong> <span id="quitPercent">0%</span></p>
    <div style="background:#333; border-radius:8px; overflow:hidden; height:20px; width:80%; max-width:300px; margin:0 auto;">
        <div id="quitProgressBar" style="background:limegreen; height:100%; width:0%;"></div>
    </div>
</div>

    <button id="recordBtn">Log</button>
</div>


<div id="reportsTab" class="tab-content" style="display:none;">
    <h2>Cigarettes per day</h2>
    <canvas id="cigsPerDayChart" width="400" height="200"></canvas>

    <!-- New Potential Money Saved section -->
    <h2>Progress Summary</h2>
<table id="progressSummary" style="width:300px; margin-bottom:20px; border-collapse: collapse; text-align:center;">
    <thead>
        <tr>
            <th style="border:1px solid #444; padding:6px;">Metric</th>
            <th style="border:1px solid #444; padding:6px;">Total</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="border:1px solid #444; padding:6px;">Cigarettes not smoked</td>
            <td id="cigsNotSmoked" style="border:1px solid #444; padding:6px;">0</td>
        </tr>
        <tr>
            <td style="border:1px solid #444; padding:6px;">Potential money saved</td>
            <td id="moneySaved" style="border:1px solid #444; padding:6px;">€0.00</td>
        </tr>
    </tbody>
</table>


    <h1>Last 10 records</h1>
    <table>
        <thead><tr><th>#</th><th>Records</th></tr></thead>
        <tbody id="recordsTableBody"></tbody>
    </table>
</div>


<script>
// ====== ONE-TIME SEEDING OF YOUR HISTORY ======
if (!localStorage.getItem('smokingRecords')) {
    function generateDayRecords(dateStr, count) {
        const records = [];
        const start = new Date(`${dateStr}T08:00:00+03:00`);
        const end = new Date(`${dateStr}T22:00:00+03:00`);
        if (count === 1) { records.push(start.toISOString()); return records; }
        const interval = (end - start) / (count - 1);
        for (let i = 0; i < count; i++) {
            records.push(new Date(start.getTime() + i * interval).toISOString());
        }
        return records;
    }
    const sept2 = generateDayRecords('2025-09-02', 17);
    const sept3 = generateDayRecords('2025-09-03', 12);
    const sept4 = generateDayRecords('2025-09-04', 11);
    const sept5 = generateDayRecords('2025-09-05', 14);
    const sept6 = generateDayRecords('2025-09-06', 11);
    const sept7 = generateDayRecords('2025-09-07', 10);
    const todayDate = new Date().toISOString().slice(0,10);
    const today = generateDayRecords(todayDate, 10);
    const all = [...today, ...sept7, ...sept6, ...sept5, ...sept4, ...sept3, ...sept2];
    localStorage.setItem('smokingRecords', JSON.stringify(all));
}
// ====== END SEEDING ======

const STORAGE_KEY = 'smokingRecords';
const LT_TIMEZONE = 'Europe/Vilnius';
const CUTOFF_HOUR = 4;
let lastCigaretteTime = null;
let timeSinceInterval = null;
let cigsChart;

function getRecords() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}
function saveRecords(records) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}
function isSameCustomDay(dateA, dateB) {
    const shiftedA = new Date(dateA.getTime() - CUTOFF_HOUR * 60 * 60 * 1000);
    const shiftedB = new Date(dateB.getTime() - CUTOFF_HOUR * 60 * 60 * 1000);
    return shiftedA.toLocaleDateString('lt-LT', { timeZone: LT_TIMEZONE }) ===
           shiftedB.toLocaleDateString('lt-LT', { timeZone: LT_TIMEZONE });
}
function getCustomDayKey(date) {
    const shifted = new Date(date.getTime() - CUTOFF_HOUR * 60 * 60 * 1000);
    return shifted.toLocaleDateString('lt-LT', { timeZone: LT_TIMEZONE });
}
function updateTimeSince() {
    if (!lastCigaretteTime) { timeSinceEl.textContent = '–'; return; }
    const diffMs = Date.now() - lastCigaretteTime.getTime();
    const h = Math.floor(diffMs / (1000 * 60 * 60));
    const m = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((diffMs % (1000 * 60)) / 1000);
    timeSinceEl.textContent = `${h}h ${m}m ${s}s`;
}

const recordBtn = document.getElementById('recordBtn');
const totalTodayEl = document.getElementById('totalToday');
const avgTimeEl = document.getElementById('avgTime');
const lastTimeEl = document.getElementById('lastTime');
const timeSinceEl = document.getElementById('timeSince');
const recordsTableBody = document.getElementById('recordsTableBody');

function loadRecords() {
    const data = getRecords();
    const now = new Date();
    const todayRecords = data.filter(ts => isSameCustomDay(new Date(ts), now));

    totalTodayEl.textContent = todayRecords.length;

    // === Build daily counts with ISO keys ===
    const dailyCounts = {};
    data.forEach(ts => {
        const dateObj = new Date(ts);
        const shifted = new Date(dateObj.getTime() - CUTOFF_HOUR * 60 * 60 * 1000);
        const isoKey = shifted.toISOString().slice(0, 10); // YYYY-MM-DD
        dailyCounts[isoKey] = (dailyCounts[isoKey] || 0) + 1;
    });

    // === Quitting Progress based on yesterday's total ===
    const baselinePerDay = 20; // old habit
    const sortedKeys = Object.keys(dailyCounts).sort(); // ISO keys sort naturally
    let yesterdayCount = null;
    if (sortedKeys.length > 1) {
        const yesterdayKey = sortedKeys[sortedKeys.length - 2];
        yesterdayCount = dailyCounts[yesterdayKey] || 0;
    }
    let progress = 0;
    if (yesterdayCount !== null) {
        progress = Math.max(0, Math.min(100, ((baselinePerDay - yesterdayCount) / baselinePerDay) * 100));
    }
    const quitPercentEl = document.getElementById('quitPercent');
    const quitBarEl = document.getElementById('quitProgressBar');
    if (quitPercentEl) quitPercentEl.textContent = `${progress.toFixed(0)}%`;
    if (quitBarEl) quitBarEl.style.width = `${progress}%`;
    // === End Quitting Progress ===

    // === Tracker stats ===
    if (todayRecords.length > 0) {
        lastCigaretteTime = new Date(todayRecords[0]);
        lastTimeEl.textContent = lastCigaretteTime.toLocaleString('lt-LT', { timeZone: LT_TIMEZONE });
        if (timeSinceInterval) clearInterval(timeSinceInterval);
        updateTimeSince();
        timeSinceInterval = setInterval(updateTimeSince, 1000);
    } else {
        lastCigaretteTime = null;
        lastTimeEl.textContent = '–';
        timeSinceEl.textContent = '–';
    }

    if (todayRecords.length > 1) {
        let totalDiffMs = 0;
        for (let i = 0; i < todayRecords.length - 1; i++) {
            totalDiffMs += (new Date(todayRecords[i]) - new Date(todayRecords[i + 1]));
        }
        const avgMs = totalDiffMs / (todayRecords.length - 1);
        const h = Math.floor(avgMs / (1000 * 60 * 60));
        const m = Math.floor((avgMs % (1000 * 60 * 60)) / (1000 * 60));
        avgTimeEl.textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
    } else {
        avgTimeEl.textContent = '–';
    }

    // === Last 10 records table ===
    recordsTableBody.innerHTML = data
        .slice(0, 10)
        .map((ts, i) => `<tr><td>${i + 1}</td><td>${new Date(ts).toLocaleString('lt-LT', { timeZone: LT_TIMEZONE })}</td></tr>`)
        .join('');

    // === Streak calculation ===
  let streak = 0;
let longestStreak = 0;
let prevCount = null;

sortedKeys.forEach(key => {
    const count = dailyCounts[key];
    if (prevCount === null || count <= prevCount) {
        streak++;
    } else {
        streak = 0; // reset streak
    }
    if (streak > longestStreak) {
        longestStreak = streak;
    }
    prevCount = count;
});

const streakEl = document.getElementById('streakDays');
if (streakEl) streakEl.textContent = streak;

const longestStreakEl = document.getElementById('longestStreak');
if (longestStreakEl) longestStreakEl.textContent = longestStreak;
;

// === Chart update ===
// Oldest on the left, newest on the right
const labels = sortedKeys.map(k => {
    const [y, m, d] = k.split('-');
    return new Date(`${y}-${m}-${d}`).toLocaleDateString('lt-LT', { timeZone: LT_TIMEZONE });
});
const counts = sortedKeys.map(k => dailyCounts[k]);


    const ctx = document.getElementById('cigsPerDayChart').getContext('2d');
    if (cigsChart) {
        cigsChart.data.labels = labels;
        cigsChart.data.datasets[0].data = counts;
        cigsChart.update();
    } else {
        cigsChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels, 
                datasets: [{ 
                    label: 'Cigarettes per day', 
                    data: counts, 
                    backgroundColor: '#ff4d4d' 
                }] 
            },
            options: {
                responsive: true,
                plugins: { 
                    legend: { 
                        labels: { color: '#fff' } 
                    } 
                },
                scales: {
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: '#444' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#fff' },
                        grid: { color: '#444' }
                    }
                }
            }
        });
    }
}

// === Reports tab: money saved + cigarettes avoided ===
function updateReports() {
    const pricePerCig = 0.215; // EUR
    const baselinePerDay = 20; // old habit

    const data = getRecords();
    const dailyCounts = {};
    data.forEach(ts => {
        const dateObj = new Date(ts);
        const shifted = new Date(dateObj.getTime() - CUTOFF_HOUR * 60 * 60 * 1000);
        const isoKey = shifted.toISOString().slice(0, 10);
        dailyCounts[isoKey] = (dailyCounts[isoKey] || 0) + 1;
    });

    let totalSavedMoney = 0;
    let totalNotSmoked = 0;
    Object.values(dailyCounts).forEach(smoked => {
        const avoided = Math.max(0, baselinePerDay - smoked);
        totalNotSmoked += avoided;
        totalSavedMoney += avoided * pricePerCig;
    });

    const moneyEl = document.getElementById('moneySaved');
    const cigsEl = document.getElementById('cigsNotSmoked');
    if (moneyEl) moneyEl.textContent = `€${totalSavedMoney.toFixed(2)}`;
    if (cigsEl) cigsEl.textContent = totalNotSmoked;
}

// === Log button ===
recordBtn.addEventListener('click', () => {
    const records = getRecords();
    records.unshift(new Date().toISOString()); // newest first
    saveRecords(records);
    loadRecords();
    updateReports(); // keep Reports in sync
});

loadRecords();

// Tab switching
const tabTracker = document.getElementById('tabTracker');
const tabReports = document.getElementById('tabReports');
const trackerTab = document.getElementById('trackerTab');
const reportsTab = document.getElementById('reportsTab');

tabTracker.addEventListener('click', () => {
    tabTracker.classList.add('active');
    tabReports.classList.remove('active');
    trackerTab.style.display = 'block';
    reportsTab.style.display = 'none';
});

tabReports.addEventListener('click', () => {
    tabReports.classList.add('active');
    tabTracker.classList.remove('active');
    trackerTab.style.display = 'none';
    reportsTab.style.display = 'block';
    updateReports(); // refresh money saved when opening Reports
});
</script>

<<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('SW registered with scope:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
}
</script>

</body>
</html>
